Re-writing in Lua.

See the HACKING file.
