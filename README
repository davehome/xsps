Re-writing in Lua.^H^H^H^HC.

See the HACKING file.
